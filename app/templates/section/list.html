{% extends "base.html" %}
{% block title %}Sections & Batches{% endblock %}
{% block page_title %}Sections & Batches{% endblock %}

{% block content %}
<div class="row mb-4" data-aos="fade-down">
    <div class="col-12">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
            <div>
                <p class="text-muted mb-0">Manage class sections and lab batches (G1/G2)</p>
            </div>
            <div>
                <a href="{{ url_for('section.add_section') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Add Section
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Semester Filter -->
<div class="row mb-4" data-aos="fade-up">
    <div class="col-12">
        <div class="glass-card p-3">
            <div class="d-flex flex-wrap align-items-center gap-2">
                <span class="fw-medium me-2">Filter by Semester:</span>
                <button class="btn btn-sm btn-primary active" onclick="filterSemester('all')">All</button>
                {% for sem in range(1, 9) %}
                <button class="btn btn-sm btn-outline-primary sem-filter" onclick="filterSemester({{ sem }})">
                    Sem {{ sem }}
                </button>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Sections by Semester -->
{% for semester in range(1, 9) %}
<div class="semester-group" data-semester="{{ semester }}">
    <h5 class="mb-3" data-aos="fade-right">
        <span class="badge bg-primary me-2">Semester {{ semester }}</span>
        <small class="text-muted">({{ sections|selectattr('semester', 'equalto', semester)|list|length }}
            sections)</small>
    </h5>

    <div class="row g-4 mb-4">
        {% for section in sections if section.semester == semester %}
        <div class="col-lg-4 col-md-6" data-aos="fade-up" data-aos-delay="{{ loop.index0 * 100 }}">
            <div class="glass-card h-100">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-users-class me-2 text-primary"></i>
                        {{ section.name }}
                    </h5>
                    {% if section.is_active %}
                    <span class="badge bg-success">Active</span>
                    {% else %}
                    <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between text-muted mb-1">
                            <small>Students</small>
                            <small>{{ section.strength }}</small>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-primary"
                                style="width: {{ [(section.strength / 80 * 100), 100]|min }}%"></div>
                        </div>
                    </div>

                    <div class="d-flex gap-2 mb-3">
                        <span class="badge bg-info-subtle text-info">
                            <i class="fas fa-graduation-cap me-1"></i>Sem {{ section.semester }}
                        </span>
                        {% if section.academic_year %}
                        <span class="badge bg-warning-subtle text-warning">
                            <i class="fas fa-calendar me-1"></i>{{ section.academic_year }}
                        </span>
                        {% endif %}
                    </div>

                    <!-- Batches -->
                    <div class="batches-section">
                        <h6 class="text-muted mb-2">
                            <i class="fas fa-layer-group me-1"></i>Lab Batches
                        </h6>
                        {% if section.batches %}
                        <div class="batch-list">
                            {% for batch in section.batches %}
                            <div
                                class="batch-item d-flex justify-content-between align-items-center p-2 mb-1 rounded bg-light">
                                <span>
                                    <i class="fas fa-users me-1 text-success"></i>
                                    {{ batch.name }}
                                </span>
                                <span class="badge bg-secondary">{{ batch.strength }} students</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-muted small">
                            <i class="fas fa-info-circle me-1"></i>No batches defined
                        </div>
                        {% endif %}

                        <button class="btn btn-sm btn-outline-success mt-2 w-100" data-bs-toggle="modal"
                            data-bs-target="#batchModal{{ section.id }}">
                            <i class="fas fa-plus me-1"></i>Manage Batches
                        </button>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0">
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('section.edit_section', id=section.id) }}"
                            class="btn btn-sm btn-outline-primary flex-fill">
                            <i class="fas fa-edit me-1"></i>Edit
                        </a>
                        <a href="{{ url_for('mapping.list_mappings') }}?section={{ section.id }}"
                            class="btn btn-sm btn-outline-info flex-fill">
                            <i class="fas fa-link me-1"></i>Mappings
                        </a>
                        <button class="btn btn-sm btn-outline-danger"
                            onclick="confirmDelete('{{ url_for('section.delete_section', id=section.id) }}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="glass-card p-4 text-center text-muted">
                <i class="fas fa-inbox fa-2x mb-2"></i>
                <p class="mb-0">No sections for Semester {{ semester }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endfor %}

<!-- Batch Management Modals -->
{% for section in sections %}
<div class="modal fade" id="batchModal{{ section.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-card">
            <div class="modal-header border-0">
                <h5 class="modal-title">
                    <i class="fas fa-layer-group me-2 text-success"></i>
                    Manage Batches - {{ section.name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('section.manage_batches', section_id=section.id) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Batches are used for lab sessions where students are divided into groups (G1, G2, etc.)
                    </div>

                    <div id="batchesContainer{{ section.id }}">
                        {% for batch in section.batches %}
                        <div class="batch-input-row d-flex gap-2 mb-2">
                            <input type="text" class="form-control" name="batch_name[]" value="{{ batch.name }}"
                                placeholder="Batch Name" required>
                            <input type="number" class="form-control" name="batch_strength[]"
                                value="{{ batch.strength }}" placeholder="Strength" min="1" required
                                style="width: 100px;">
                            <button type="button" class="btn btn-outline-danger" onclick="removeBatchRow(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        {% else %}
                        <div class="batch-input-row d-flex gap-2 mb-2">
                            <input type="text" class="form-control" name="batch_name[]" value="G1"
                                placeholder="Batch Name" required>
                            <input type="number" class="form-control" name="batch_strength[]"
                                value="{{ section.strength // 2 }}" placeholder="Strength" min="1" required
                                style="width: 100px;">
                            <button type="button" class="btn btn-outline-danger" onclick="removeBatchRow(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="batch-input-row d-flex gap-2 mb-2">
                            <input type="text" class="form-control" name="batch_name[]" value="G2"
                                placeholder="Batch Name" required>
                            <input type="number" class="form-control" name="batch_strength[]"
                                value="{{ section.strength - section.strength // 2 }}" placeholder="Strength" min="1"
                                required style="width: 100px;">
                            <button type="button" class="btn btn-outline-danger" onclick="removeBatchRow(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>

                    <button type="button" class="btn btn-sm btn-outline-success mb-3"
                        onclick="addBatchRow('batchesContainer{{ section.id }}')">
                        <i class="fas fa-plus me-1"></i>Add Batch
                    </button>

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-2"></i>Save Batches
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block extra_css %}
<style>
    .batch-item {
        transition: all 0.2s;
    }

    .batch-item:hover {
        background: rgba(0, 0, 0, 0.05) !important;
    }

    .sem-filter.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    function filterSemester(semester) {
        // Update button states
        document.querySelectorAll('.sem-filter, .btn-primary').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // Filter sections
        document.querySelectorAll('.semester-group').forEach(group => {
            if (semester === 'all' || group.dataset.semester == semester) {
                group.style.display = 'block';
            } else {
                group.style.display = 'none';
            }
        });
    }

    function addBatchRow(containerId) {
        const container = document.getElementById(containerId);
        const newRow = document.createElement('div');
        newRow.className = 'batch-input-row d-flex gap-2 mb-2';
        newRow.innerHTML = `
        <input type="text" class="form-control" name="batch_name[]" placeholder="Batch Name" required>
        <input type="number" class="form-control" name="batch_strength[]" placeholder="Strength" min="1" required style="width: 100px;">
        <button type="button" class="btn btn-outline-danger" onclick="removeBatchRow(this)">
            <i class="fas fa-times"></i>
        </button>
    `;
        container.appendChild(newRow);
    }

    function removeBatchRow(btn) {
        const container = btn.closest('.batch-input-row').parentElement;
        if (container.querySelectorAll('.batch-input-row').length > 1) {
            btn.closest('.batch-input-row').remove();
        } else {
            showToast('At least one batch is required', 'warning');
        }
    }

    function confirmDelete(url) {
        Swal.fire({
            title: 'Are you sure?',
            text: "This will delete the section and all related mappings!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#64748b',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = url;
            }
        });
    }
</script>
{% endblock %}